name: Complete CI/CD Pipeline - Build, Test, Docker, Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  # ============================================================================
  # PHASE 1: BUILD APPLICATION (15%)
  # ============================================================================

  build-backend-java:
    name: Build Java Services (Maven)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [identity-service, scrum-core-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # CACHING (15%) - Maven dependencies
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build ${{ matrix.service }}
        working-directory: ./backend/${{ matrix.service }}
        run: mvn clean package -DskipTests

      # ARTIFACTS (15%) - Store build output
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: backend/${{ matrix.service }}/target/*.jar
          retention-days: 30

  build-backend-nodejs:
    name: Build Node.js Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [collaboration-service, reporting-service, logging-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # CACHING (15%) - Node modules
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: backend/${{ matrix.service }}/node_modules
          key: ${{ runner.os }}-node-${{ matrix.service }}-${{ hashFiles(format('backend/{0}/package-lock.json', matrix.service)) }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.service }}-

      - name: Install dependencies
        working-directory: ./backend/${{ matrix.service }}
        run: npm ci

      - name: Build ${{ matrix.service }}
        working-directory: ./backend/${{ matrix.service }}
        run: npm run build

      # ARTIFACTS (15%) - Store build output
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: backend/${{ matrix.service }}/dist
          retention-days: 30

  build-frontend:
    name: Build Frontend Applications
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [admin-portal, team-portal]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # CACHING (15%) - Node modules
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: frontend/${{ matrix.app }}/node_modules
          key: ${{ runner.os }}-frontend-${{ matrix.app }}-${{ hashFiles(format('frontend/{0}/package-lock.json', matrix.app)) }}
          restore-keys: |
            ${{ runner.os }}-frontend-${{ matrix.app }}-

      - name: Install dependencies
        working-directory: ./frontend/${{ matrix.app }}
        run: npm ci

      - name: Build ${{ matrix.app }}
        working-directory: ./frontend/${{ matrix.app }}
        run: npm run build

      # ARTIFACTS (15%) - Store dist folder
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-dist
          path: frontend/${{ matrix.app }}/dist
          retention-days: 30

  # ============================================================================
  # PHASE 2: RUN TESTS (Existing tests)
  # ============================================================================

  test-backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    needs: [build-backend-java, build-backend-nodejs]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run identity-service tests
        working-directory: ./backend/identity-service
        run: mvn test

      - name: Generate coverage report
        working-directory: ./backend/identity-service
        run: mvn jacoco:report

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/identity-service/target/site/jacoco/
          retention-days: 30

  test-frontend:
    name: Test Frontend Applications
    runs-on: ubuntu-latest
    needs: [build-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: frontend/team-portal/node_modules
          key: ${{ runner.os }}-frontend-team-portal-${{ hashFiles('frontend/team-portal/package-lock.json') }}

      - name: Install dependencies
        working-directory: ./frontend/team-portal
        run: npm ci

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser

      - name: Run tests with coverage
        working-directory: ./frontend/team-portal
        run: npm run test -- --no-watch --code-coverage --browsers=ChromeHeadless
        env:
          CHROME_BIN: /usr/bin/chromium-browser

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/team-portal/coverage/
          retention-days: 30

  # ============================================================================
  # PHASE 3: BUILD DOCKER IMAGES (20%)
  # ============================================================================

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - service: identity-service
            context: ./backend/identity-service
          - service: scrum-core-service
            context: ./backend/scrum-core-service
          - service: collaboration-service
            context: ./backend/collaboration-service
          - service: reporting-service
            context: ./backend/reporting-service
          - service: logging-service
            context: ./backend/logging-service
          - service: admin-portal
            context: ./frontend/admin-portal
          - service: team-portal
            context: ./frontend/team-portal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # CACHING (15%) - Docker layer cache
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-
            ${{ runner.os }}-buildx-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: false
          tags: ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          load: true

      # Move cache to avoid growing indefinitely
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Save Docker image
        run: |
          docker save ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:latest > /tmp/${{ matrix.service }}.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-${{ matrix.service }}
          path: /tmp/${{ matrix.service }}.tar
          retention-days: 1

  # ============================================================================
  # PHASE 4: PUSH TO DOCKER HUB (15%)
  # ============================================================================

  push-docker-images:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: [build-docker-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [identity-service, scrum-core-service, collaboration-service, reporting-service, logging-service, admin-portal, team-portal]

    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-${{ matrix.service }}
          path: /tmp

      - name: Load Docker image
        run: docker load < /tmp/${{ matrix.service }}.tar

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag image with version
        run: |
          docker tag ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:latest \
                     ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:${{ github.sha }}

      - name: Push to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}:${{ github.sha }}

      - name: Verify image is on Docker Hub
        run: |
          echo "âœ… Image pushed successfully to Docker Hub"
          echo "ðŸ”— View at: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/scrum-${{ matrix.service }}"

  # ============================================================================
  # PHASE 5: DEPLOY TO RENDER (20%)
  # ============================================================================

  deploy-to-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [push-docker-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "ðŸš€ Deploying to Render..."

          # Trigger Render deployment via API
          # This will pull the latest images from Docker Hub

          for service in identity-service scrum-core-service collaboration-service reporting-service logging-service; do
            echo "Deploying $service..."
            curl -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID_PREFIX }}-${service}?key=${RENDER_API_KEY}" || true
          done

          echo "âœ… Deployment triggered successfully!"
          echo "ðŸŒ Your app will be available at the Render URLs in a few minutes"

      - name: Health check
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 60

          # Add your Render URL here for health checks
          # Example: curl -f https://your-app.onrender.com/health || echo "Service starting..."

          echo "âœ… Deployment complete!"

  # ============================================================================
  # SUMMARY
  # ============================================================================

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-to-render]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Phases:" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Phase** - All services built with caching" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Test Phase** - Tests executed with coverage" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Docker Build** - Images built with layer caching" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Docker Push** - Images pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deploy** - Application deployed to Render" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Available:" >> $GITHUB_STEP_SUMMARY
          echo "- JAR files (Java services)" >> $GITHUB_STEP_SUMMARY
          echo "- Build outputs (Node.js services)" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend dist folders" >> $GITHUB_STEP_SUMMARY
          echo "- Test coverage reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images:" >> $GITHUB_STEP_SUMMARY
          echo "All images available at: https://hub.docker.com/u/${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status:" >> $GITHUB_STEP_SUMMARY
          echo "Result: ${{ needs.deploy-to-render.result }}" >> $GITHUB_STEP_SUMMARY
